---
title: 1. Architecture
author: aimpugn
date: 2021-07-21 21:40:00+0900
use_math: true
categories: [db, postgres]
---

- [PostgreSQL 아키텍처](#postgresql-아키텍처)
  - [[개요]](#개요)
    - [Shared Memory](#shared-memory)
      - [Shared Buffer](#shared-buffer)
      - [WAL Buffer](#wal-buffer)
        - [개요](#개요-1)
        - [`CHECKPOINT`](#checkpoint)
          - [`checkpoint_timeout` 조회](#checkpoint_timeout-조회)
          - [`checkpoint_completion_target`](#checkpoint_completion_target)
        - [`max_wal_size` 조회](#max_wal_size-조회)
        - [`Dynamic WAL Switching`](#dynamic-wal-switching)

# PostgreSQL 아키텍처

## [개요]

[![개요도](../../assets/images/db/postgres/ch1/postgres_architecture.jpg)](https://distributedsystemsauthority.com/postgresql-high-performance-guide-architecture/)

### Shared Memory

#### Shared Buffer

- DISK I/O 최소화가 목적
  - 매우 큰(수십, 수백 GB) 버퍼를 빠르게 액세스
  - 많은 사용자 동시 접근 시 경합 최소화
  - 자주 사용되는 블록은 최대한 오랫동안 버퍼 내 유지
- 백엔드 프로세스는 파일을 읽고 쓰는 게 아니라 버퍼와 램을 읽고 쓴다
- `postgresql.config` 파일의 `shared_buffers` 변수에 정해진 고정된 값의 메모리가 서버가 시작될 때 할당된다

#### WAL Buffer

##### 개요

> DB의 데이터 변경  
> $\to$ WAL 버퍼와 Data 버퍼 쓰기  
> $\to$ COMMIT 발생  
> $\to$ WAL 버퍼의 데이터를 디스크로 flush  
> $\to$ CHECKPOINT 발생  
> $\to$ 모든 데이터 버퍼를 디스크로 flush

- `WAL(Write-Ahead Log)`? 말 그대로 **로그를 남기고 데이터를 저장**한다는 의미
- `WAL Buffer`? 데이터베이스의 변경 사항을 잠시 저장하는 버퍼
- 매번 모든 커밋을 바로 파일에 쓰지 않기 때문에 성능 향상
- 모든 변화는 WAL 파일에 기록되므로 장애 시에도 복구가 용이하다

##### `CHECKPOINT`

- `CHECKPOINT`?
  - 만약 DB가 모든 데이터 변경 사항이 디스크로 flush된 WAL 로그의 위치를 보장할 수 있다면? 장애 복구 시 나머지 WAL 부분에 대해서만 replay를 하면 된다
  - 체크포인트는 특정 시점 이전의 WAL에 대한 복구가 더이상 필요치 않음을 보장한다
  - 이를 통해 디스크 공간 요구사항과 복구 시간을 줄일 수 있다
- `CHECKPOINT` 발생 시점?
  - `CHECKPOINT` 명령어 실행
  - `CHECKPOINT`를 필요로 하는 명령 실행(`pg_start_backup`, `pg_ctl start|restart` 등)
  - `checkpoint_timeout` 시간에 도달
  - `max_wal_size`가 가득찬 경우
- [`CHECKPOINT` 발생 시 DB는 다음 세 단계 수행](https://www.2ndquadrant.com/en/blog/basics-of-tuning-checkpoints/)
  - shared buffer에 dirty block(수정된 블록)이 있는지 찾는다
  - 모두 디스크(또는 파일 시스템 캐시)에 쓰기
  - 모든 수정된 파일들을 디스크에 `fsync()`

###### `checkpoint_timeout` 조회

```sql
postgres=# SHOW checkpoint_timeout;
 checkpoint_timeout
--------------------
 5min
(1개 행)
```

###### `checkpoint_completion_target`

- 대량의 페이지 쓰기가 갑작스럽게 이뤄져서 I/O 부하가 발생하는 것을 피하기 위한 설정
- `checkpoint_timeout`이 5min, `checkpoint_completion_target`가 0.5면?
  - DB는 마지막 쓰기가 2.5분 뒤에 이뤄지도록 쓰기를 제한(throttle)
  - OS는 데이터를 디스크에 쓸 2.5분이 더 생기고
  - `fsync()`는 그만큼 비용이 저렴해지고 빨라진다

##### `max_wal_size` 조회

```sql
postgres=# SHOW max_wal_size;
 max_wal_size
--------------
 1GB
(1개 행)
```

##### `Dynamic WAL Switching`

- pg 9.6 버전부터 도입된 모델

> 단일 WAL 파일이 가득 차고(기본 16MB) 남은 디스크 공간이 부족해질 때까지 WAL log 쓰기  
> $\to$ 다음 쓰기를 위해 오래된 WAL 파일 사용
